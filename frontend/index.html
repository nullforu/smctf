<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>smctf PoC</title>
        <style>
            :root {
                --bg: #f7f7f7;
                --card: #ffffff;
                --text: #1d1d1f;
                --muted: #6b7280;
                --border: #e5e7eb;
                --accent: #2563eb;
            }
            * {
                box-sizing: border-box;
            }
            body {
                margin: 0;
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    sans-serif;
                background: var(--bg);
                color: var(--text);
            }
            header {
                padding: 16px 20px;
                border-bottom: 1px solid var(--border);
                background: var(--card);
            }
            main {
                max-width: 980px;
                margin: 20px auto 60px;
                padding: 0 16px;
                display: grid;
                gap: 16px;
            }
            .row {
                display: grid;
                gap: 16px;
            }
            @media (min-width: 860px) {
                .row {
                    grid-template-columns: 1fr 1fr;
                }
            }
            .card {
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 16px;
            }
            h1,
            h2,
            h3 {
                margin: 0 0 12px;
            }
            h1 {
                font-size: 20px;
            }
            h2 {
                font-size: 16px;
            }
            label {
                display: block;
                font-size: 12px;
                color: var(--muted);
                margin: 10px 0 4px;
            }
            input,
            textarea,
            select,
            button {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid var(--border);
                border-radius: 6px;
                font-size: 14px;
            }
            textarea {
                min-height: 80px;
            }
            button {
                background: var(--accent);
                color: #fff;
                border: none;
                cursor: pointer;
                margin-top: 10px;
            }
            button.secondary {
                background: #111827;
            }
            button.ghost {
                background: transparent;
                border: 1px solid var(--border);
                color: var(--text);
            }
            .muted {
                color: var(--muted);
                font-size: 12px;
            }
            .inline {
                display: flex;
                gap: 8px;
                align-items: center;
            }
            .inline > * {
                flex: 1;
            }
            .list {
                display: grid;
                gap: 8px;
            }
            .pill {
                display: inline-block;
                padding: 2px 8px;
                border-radius: 999px;
                border: 1px solid var(--border);
                font-size: 11px;
            }
            pre {
                background: #0b1020;
                color: #d1d5db;
                padding: 10px;
                border-radius: 6px;
                overflow-x: auto;
            }
            .success {
                color: #059669;
            }
            .error {
                color: #dc2626;
            }
            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>smctf PoC Frontend</h1>
            <div class="inline">
                <div>
                    <label>API Base URL</label>
                    <input id="baseUrl" value="http://localhost:8080" />
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button class="ghost" id="saveBase">Save</button>
                </div>
            </div>
            <div id="sessionInfo" class="muted" style="margin-top: 8px">Not logged in</div>
        </header>

        <main>
            <div class="row">
                <section class="card">
                    <h2>Register</h2>
                    <label>Email</label>
                    <input id="regEmail" />
                    <label>Username</label>
                    <input id="regUsername" />
                    <label>Password</label>
                    <input id="regPassword" type="password" />
                    <button id="btnRegister">Register</button>
                    <div id="regMsg" class="muted"></div>
                </section>

                <section class="card">
                    <h2>Login</h2>
                    <label>Email</label>
                    <input id="loginEmail" />
                    <label>Password</label>
                    <input id="loginPassword" type="password" />
                    <button id="btnLogin">Login</button>
                    <button class="secondary" id="btnLogout">Logout</button>
                    <button class="ghost" id="btnRefresh">Refresh Tokens</button>
                    <div id="loginMsg" class="muted"></div>
                </section>
            </div>

            <section class="card">
                <h2>Me</h2>
                <div class="inline">
                    <button id="btnMe">Load /api/me</button>
                    <button class="ghost" id="btnMeSolved">Load /api/me/solved</button>
                </div>
                <pre id="meOut">{}</pre>
                <pre id="meSolvedOut">[]</pre>
            </section>

            <section class="card">
                <h2>Challenges</h2>
                <div class="inline">
                    <button id="btnLoadChallenges">Load Challenges</button>
                    <button class="ghost" id="btnLoadScoreboard">Load Scoreboard</button>
                    <button class="ghost" id="btnLoadTimeline">Load Timeline</button>
                </div>
                <div class="row" style="margin-top: 12px">
                    <div>
                        <h3>Challenge List</h3>
                        <div id="challengeList" class="list"></div>
                    </div>
                    <div>
                        <h3>Submit Flag</h3>
                        <label>Challenge ID</label>
                        <input id="submitChallengeId" />
                        <label>Flag</label>
                        <input id="submitFlag" />
                        <button id="btnSubmit">Submit</button>
                        <div id="submitMsg" class="muted"></div>
                        <h3 style="margin-top: 18px">Scoreboard</h3>
                        <pre id="scoreOut">[]</pre>
                        <label>Timeline interval (minutes)</label>
                        <input id="timelineInterval" type="number" value="10" />
                        <pre id="timelineOut">{}</pre>
                    </div>
                </div>
            </section>

            <section class="card" id="adminSection">
                <h2>Admin: Create Challenge</h2>
                <div class="muted">Only visible for role=admin.</div>
                <label>Title</label>
                <input id="adminTitle" />
                <label>Description</label>
                <textarea id="adminDesc"></textarea>
                <div class="inline">
                    <div>
                        <label>Points</label>
                        <input id="adminPoints" type="number" value="100" />
                    </div>
                    <div>
                        <label>Active</label>
                        <select id="adminActive">
                            <option value="true">true</option>
                            <option value="false">false</option>
                        </select>
                    </div>
                </div>
                <label>Flag</label>
                <input id="adminFlag" />
                <button id="btnCreateChallenge">Create</button>
                <div id="adminMsg" class="muted"></div>
            </section>
        </main>

        <script>
            const $ = (id) => document.getElementById(id)

            const state = {
                baseUrl: localStorage.getItem('smctf_base_url') || 'http://localhost:8080',
                accessToken: localStorage.getItem('smctf_access') || '',
                refreshToken: localStorage.getItem('smctf_refresh') || '',
                user: JSON.parse(localStorage.getItem('smctf_user') || 'null'),
            }

            $('baseUrl').value = state.baseUrl

            function saveSession() {
                localStorage.setItem('smctf_access', state.accessToken || '')
                localStorage.setItem('smctf_refresh', state.refreshToken || '')
                localStorage.setItem('smctf_user', JSON.stringify(state.user))
            }

            function setMessage(el, msg, ok = true) {
                el.textContent = msg || ''
                el.className = ok ? 'muted success' : 'muted error'
            }

            function updateSessionUI() {
                if (state.user) {
                    $('sessionInfo').textContent = `Logged in as ${state.user.username} (${state.user.role})`
                } else {
                    $('sessionInfo').textContent = 'Not logged in'
                }
                if (state.user && state.user.role === 'admin') {
                    $('adminSection').classList.remove('hidden')
                } else {
                    $('adminSection').classList.add('hidden')
                }
            }

            async function api(path, opts = {}) {
                const url = `${state.baseUrl}${path}`
                const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {})
                if (state.accessToken) headers.Authorization = `Bearer ${state.accessToken}`
                const res = await fetch(url, { ...opts, headers })
                let body = null
                const text = await res.text()
                try {
                    body = text ? JSON.parse(text) : null
                } catch {
                    body = { raw: text }
                }
                if (!res.ok) {
                    const err = body && body.error ? body.error : `HTTP ${res.status}`
                    throw new Error(err)
                }
                return body
            }

            $('saveBase').onclick = () => {
                state.baseUrl = $('baseUrl').value.trim() || 'http://localhost:8080'
                localStorage.setItem('smctf_base_url', state.baseUrl)
                setMessage($('sessionInfo'), `Base URL saved: ${state.baseUrl}`, true)
                updateSessionUI()
            }

            $('btnRegister').onclick = async () => {
                try {
                    const body = {
                        email: $('regEmail').value.trim(),
                        username: $('regUsername').value.trim(),
                        password: $('regPassword').value,
                    }
                    const res = await api('/api/auth/register', { method: 'POST', body: JSON.stringify(body) })
                    setMessage($('regMsg'), `Registered: ${res.email}`, true)
                } catch (err) {
                    setMessage($('regMsg'), err.message, false)
                }
            }

            $('btnLogin').onclick = async () => {
                try {
                    const body = {
                        email: $('loginEmail').value.trim(),
                        password: $('loginPassword').value,
                    }
                    const res = await api('/api/auth/login', { method: 'POST', body: JSON.stringify(body) })
                    state.accessToken = res.access_token
                    state.refreshToken = res.refresh_token
                    state.user = res.user
                    saveSession()
                    updateSessionUI()
                    setMessage($('loginMsg'), 'Login success', true)
                } catch (err) {
                    setMessage($('loginMsg'), err.message, false)
                }
            }

            $('btnLogout').onclick = async () => {
                if (!state.refreshToken) {
                    setMessage($('loginMsg'), 'No refresh token', false)
                    return
                }
                try {
                    await api('/api/auth/logout', {
                        method: 'POST',
                        body: JSON.stringify({ refresh_token: state.refreshToken }),
                    })
                } catch (err) {
                    setMessage($('loginMsg'), err.message, false)
                }
                state.accessToken = ''
                state.refreshToken = ''
                state.user = null
                saveSession()
                updateSessionUI()
                setMessage($('loginMsg'), 'Logged out', true)
            }

            $('btnRefresh').onclick = async () => {
                if (!state.refreshToken) {
                    setMessage($('loginMsg'), 'No refresh token', false)
                    return
                }
                try {
                    const res = await api('/api/auth/refresh', {
                        method: 'POST',
                        body: JSON.stringify({ refresh_token: state.refreshToken }),
                    })
                    state.accessToken = res.access_token
                    state.refreshToken = res.refresh_token
                    saveSession()
                    setMessage($('loginMsg'), 'Token refreshed', true)
                } catch (err) {
                    setMessage($('loginMsg'), err.message, false)
                }
            }

            $('btnMe').onclick = async () => {
                try {
                    const res = await api('/api/me', { method: 'GET' })
                    $('meOut').textContent = JSON.stringify(res, null, 2)
                } catch (err) {
                    $('meOut').textContent = JSON.stringify({ error: err.message }, null, 2)
                }
            }

            $('btnMeSolved').onclick = async () => {
                try {
                    const res = await api('/api/me/solved', { method: 'GET' })
                    $('meSolvedOut').textContent = JSON.stringify(res, null, 2)
                } catch (err) {
                    $('meSolvedOut').textContent = JSON.stringify({ error: err.message }, null, 2)
                }
            }

            $('btnLoadChallenges').onclick = async () => {
                try {
                    const res = await api('/api/challenges', { method: 'GET' })
                    const list = $('challengeList')
                    list.innerHTML = ''
                    res.forEach((ch) => {
                        const div = document.createElement('div')
                        div.className = 'card'
                        div.innerHTML = `
              <div><strong>${ch.title}</strong> <span class="pill">${ch.points} pts</span></div>
              <div class="muted">ID: ${ch.id} | active: ${ch.is_active}</div>
              <div>${ch.description}</div>
            `
                        list.appendChild(div)
                    })
                } catch (err) {
                    $('challengeList').innerHTML = `<div class="error">${err.message}</div>`
                }
            }

            $('btnSubmit').onclick = async () => {
                try {
                    const id = $('submitChallengeId').value.trim()
                    const flag = $('submitFlag').value.trim()
                    const res = await api(`/api/challenges/${id}/submit`, {
                        method: 'POST',
                        body: JSON.stringify({ flag }),
                    })
                    setMessage($('submitMsg'), `Correct: ${res.correct}`, true)
                } catch (err) {
                    setMessage($('submitMsg'), err.message, false)
                }
            }

            $('btnLoadScoreboard').onclick = async () => {
                try {
                    const res = await api('/api/scoreboard?limit=50', { method: 'GET' })
                    $('scoreOut').textContent = JSON.stringify(res, null, 2)
                } catch (err) {
                    $('scoreOut').textContent = JSON.stringify({ error: err.message }, null, 2)
                }
            }

            $('btnLoadTimeline').onclick = async () => {
                try {
                    const interval = Number($('timelineInterval').value || 10)
                    const res = await api(`/api/scoreboard/timeline?interval=${interval}&limit=50`, { method: 'GET' })
                    $('timelineOut').textContent = JSON.stringify(res, null, 2)
                } catch (err) {
                    $('timelineOut').textContent = JSON.stringify({ error: err.message }, null, 2)
                }
            }

            $('btnCreateChallenge').onclick = async () => {
                try {
                    const body = {
                        title: $('adminTitle').value.trim(),
                        description: $('adminDesc').value.trim(),
                        points: Number($('adminPoints').value || 0),
                        flag: $('adminFlag').value.trim(),
                        is_active: $('adminActive').value === 'true',
                    }
                    const res = await api('/api/admin/challenges', { method: 'POST', body: JSON.stringify(body) })
                    setMessage($('adminMsg'), `Created: ${res.id}`, true)
                } catch (err) {
                    setMessage($('adminMsg'), err.message, false)
                }
            }

            updateSessionUI()
        </script>
    </body>
</html>
